<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UG405 ‚Äì XKOP Tool (Enhanced)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --text:#1a1d2e; --muted:#64748b; --action:#404089; --accent:#5b63f5;
  --border:#e2e8f0; --bg:#ffffff; --bg2:#f8fafc; --bg3:#eff6ff;
  --success:#10b981; --warning:#f59e0b; --error:#ef4444;
  --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
}

*{box-sizing:border-box; margin:0; padding:0}
html,body{height:100%}
body{
  background:linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
  color:var(--text);
  font-family:"Be Vietnam Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  line-height:1.6;
}
.wrapper{max-width:1440px; margin:0 auto; padding:20px}

/* Header */
.header{
  position:sticky; top:12px; z-index:50;
  background:rgba(255,255,255,0.95);
  border:1px solid var(--border);
  border-radius:12px;
  padding:18px 24px;
  display:flex; align-items:center; gap:18px; justify-content:space-between; flex-wrap:wrap;
  box-shadow:0 10px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.1);
  backdrop-filter:blur(12px);
}
.header-left,.header-right{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
.label{font-size:.82rem; color:var(--muted); font-weight:600; margin-bottom:6px; display:block; text-transform:uppercase; letter-spacing:0.5px}

/* Inputs */
.input,.select{
  height:42px;
  border:2px solid var(--border);
  background:var(--bg);
  padding:0 12px;
  border-radius:8px;
  font-size:.95rem;
  color:var(--text);
  min-width:160px;
  transition:all 0.2s ease;
}
.input:hover,.select:hover{border-color:#cbd5e1}
.select{padding-right:32px; cursor:pointer}
.input:focus,.select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(91,99,245,0.1);
}
input[disabled],select[disabled]{background:#f1f5f9; color:#94a3b8; cursor:not-allowed}
input[type="file"]{padding:10px; cursor:pointer}

/* Buttons */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:42px;
  padding:0 18px;
  border-radius:8px;
  background:var(--bg);
  border:2px solid var(--border);
  cursor:pointer;
  font-weight:600;
  color:var(--action);
  transition:all 0.2s ease;
  font-size:.9rem;
  box-shadow:var(--shadow-sm);
}
.btn:hover{
  border-color:var(--accent);
  color:var(--accent);
  transform:translateY(-1px);
  box-shadow:var(--shadow-md);
}
.btn:active{transform:translateY(0); box-shadow:var(--shadow-sm)}
.btn.primary{
  background:linear-gradient(135deg, var(--accent) 0%, #4850e4 100%);
  color:#fff;
  border-color:var(--accent);
}
.btn.primary:hover{
  background:linear-gradient(135deg, #4850e4 0%, #3a3dd0 100%);
  border-color:#3a3dd0;
}
.btn.success{background:var(--success); color:#fff; border-color:var(--success)}
.btn.success:hover{background:#059669; border-color:#059669}
.btn.warning{background:var(--warning); color:#fff; border-color:var(--warning)}
.btn.warning:hover{background:#d97706; border-color:#d97706}
.btn.danger{background:var(--error); color:#fff; border-color:var(--error)}
.btn.danger:hover{background:#dc2626; border-color:#dc2626}
.btn:disabled{opacity:0.5; cursor:not-allowed; transform:none}

/* Tabs */
.tabs{
  display:flex;
  gap:8px;
  overflow:auto;
  margin:20px 0 0;
  padding:6px;
  background:var(--bg);
  border-radius:12px 12px 0 0;
  box-shadow:var(--shadow-sm);
}
.tab{
  padding:12px 18px;
  border-radius:8px;
  font-weight:600;
  color:var(--muted);
  cursor:pointer;
  white-space:nowrap;
  transition:all 0.2s ease;
  border:2px solid transparent;
}
.tab:hover{color:var(--accent); background:var(--bg3)}
.tab.active{
  color:var(--accent);
  background:linear-gradient(135deg, var(--bg3) 0%, #dbeafe 100%);
  border-color:var(--accent);
  box-shadow:var(--shadow-sm);
}

/* Panels */
.panels{
  border:1px solid var(--border);
  background:var(--bg);
  border-radius:0 0 12px 12px;
  max-height:calc(100vh - 200px);
  overflow:auto;
  box-shadow:var(--shadow-md);
}
.panel{display:none; padding:20px}
.panel.active{display:block}

/* Tables */
.table{width:100%; border-collapse:separate; border-spacing:0}
.table th,.table td{
  padding:8px 10px;
  border-bottom:1px solid var(--border);
  font-size:.88rem;
  text-align:left;
}
.table th{
  color:var(--muted);
  background:linear-gradient(180deg, #fafbff 0%, #f1f5f9 100%);
  font-weight:700;
  position:sticky;
  top:0;
  z-index:2;
  text-transform:uppercase;
  font-size:.75rem;
  letter-spacing:0.5px;
}
.table tbody tr{transition:all 0.15s ease}
.table tbody tr:nth-child(even){background:rgba(248,250,252,0.4)}
.table tbody tr:hover{background:#f0f4f8; box-shadow:inset 0 0 0 1px #cbd5e1}
.table tbody td:nth-child(2){
  background:linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
  font-weight:600;
  text-align:center;
  border-right:2px solid var(--border);
}
#setup-table th:nth-child(1){width:40px}
#setup-table th:nth-child(2){width:50px}
#setup-table th:nth-child(3),#setup-table th:nth-child(7){width:15%}
#setup-table th:nth-child(4),#setup-table th:nth-child(8){width:10%}
#setup-table th:nth-child(5),#setup-table th:nth-child(9){width:10%}
#setup-table th:nth-child(6),#setup-table th:nth-child(10){width:8%}
.table input,.table select{height:32px; min-width:60px; font-size:.85rem; padding:0 6px}

/* Badges & Pills */
.small{font-size:.82rem; color:var(--muted)}
.pill{
  display:inline-flex;
  align-items:center;
  padding:6px 12px;
  border-radius:999px;
  font-weight:700;
  font-size:.82rem;
  box-shadow:var(--shadow-sm);
}
.pill.ok{background:#d1fae5; color:#065f46; border:1px solid #a7f3d0}
.pill.warn{background:#fef3c7; color:#92400e; border:1px solid #fde68a}
.pill.error{background:#fee2e2; color:#991b1b; border:1px solid #fecaca}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:var(--bg3);
  color:var(--accent);
  font-size:.78rem;
  font-weight:600;
  border:1px solid #bfdbfe;
}

/* Alerts */
.alert{
  padding:14px 16px;
  border-radius:10px;
  margin-bottom:14px;
  border-left:4px solid;
  box-shadow:var(--shadow-sm);
  font-weight:500;
}
.alert.info{background:#eff6ff; border-color:#3b82f6; color:#1e40af}
.alert.success{background:#ecfdf5; border-color:#10b981; color:#065f46}
.alert.warning{background:#fef3c7; border-color:#f59e0b; color:#92400e}
.alert.error{background:#fee2e2; border-color:#ef4444; color:#991b1b}

/* Code/Log display */
.code{
  font-family:"JetBrains Mono",ui-monospace,Consolas,Menlo,monospace;
  background:#0d1117;
  color:#e6edf3;
  border:1px solid #30363d;
  border-radius:10px;
  padding:14px;
  height:320px;
  overflow:auto;
  font-size:.88rem;
  line-height:1.6;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}
.log-entry{margin-bottom:4px; padding:2px 4px; border-radius:3px}
.log-entry.error{color:#ff7b72; background:rgba(255,123,114,0.1)}
.log-entry.success{color:#7ee787; background:rgba(126,231,135,0.1)}
.log-entry.info{color:#79c0ff; background:rgba(121,192,255,0.1)}

/* Actions */
.row-actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

/* Grid layouts */
.grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px}
.card{
  background:linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
  border:1px solid var(--border);
  border-radius:12px;
  padding:24px;
  box-shadow:0 2px 4px rgba(0,0,0,0.04),0 1px 2px rgba(0,0,0,0.06);
  transition:all 0.3s ease;
}
.card:hover{
  box-shadow:0 8px 16px rgba(0,0,0,0.08),0 2px 4px rgba(0,0,0,0.04);
  transform:translateY(-2px);
}
.card h3{
  margin:0 0 16px;
  color:var(--accent);
  font-size:1.2rem;
  font-weight:700;
  border-bottom:3px solid var(--accent);
  padding-bottom:10px;
  background:linear-gradient(90deg, var(--accent), #818cf8);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

/* Checkbox */
input[type="checkbox"]{
  width:18px;
  height:18px;
  cursor:pointer;
  accent-color:var(--accent);
}

/* Notification */
.notification{
  position:fixed;
  top:24px;
  right:24px;
  z-index:9999;
  max-width:420px;
  padding:14px 18px;
  border-radius:10px;
  font-weight:600;
  box-shadow:var(--shadow-lg);
  animation:slideIn 0.3s ease-out;
  border:1px solid rgba(0,0,0,0.1);
}
@keyframes slideIn{
  from{transform:translateX(calc(100% + 24px)); opacity:0}
  to{transform:translateX(0); opacity:1}
}

/* Scrollbar styling */
.panels::-webkit-scrollbar,.code::-webkit-scrollbar{width:8px; height:8px}
.panels::-webkit-scrollbar-track,.code::-webkit-scrollbar-track{background:var(--bg2); border-radius:4px}
.panels::-webkit-scrollbar-thumb,.code::-webkit-scrollbar-thumb{
  background:#cbd5e1;
  border-radius:4px;
  transition:background 0.2s;
}
.panels::-webkit-scrollbar-thumb:hover,.code::-webkit-scrollbar-thumb:hover{background:#94a3b8}

@media (max-width: 768px) {
  .grid{grid-template-columns:1fr}
  .header{flex-direction:column; align-items:stretch}
  .wrapper{padding:12px}
}
</style>
</head>
<body>
<div class="wrapper">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div>
        <div class="label">Controller IP</div>
        <input id="ip" class="input" placeholder="e.g. 172.18.1.107">
      </div>
      <div>
        <div class="label">Instation</div>
        <input id="instation_ip" class="input" placeholder="e.g. 127.0.0.1">
      </div>
      <div>
        <div class="label">XKOP</div>
        <select id="xkop" class="select">
          <option value="1">XKOP1 (8001)</option>
          <option value="2">XKOP2 (8002)</option>
          <option value="3">XKOP3 (8003)</option>
          <option value="4">XKOP4 (8004)</option>
          <option value="5">XKOP5 (8005)</option>
          <option value="6">XKOP6 (8006)</option>
          <option value="7">XKOP7 (8007)</option>
          <option value="8">XKOP8 (8008)</option>
          <option value="9">XKOP9 (8009)</option>
          <option value="10">XKOP10 (8010)</option>
          <option value="11">XKOP11 (8011)</option>
          <option value="12">XKOP12 (8012)</option>
          <option value="13">XKOP13 (8013)</option>
          <option value="14">XKOP14 (8014)</option>
          <option value="15">XKOP15 (8015)</option>
          <option value="16">XKOP16 (8016)</option>
          <option value="17">XKOP17 (8017)</option>
          <option value="18">XKOP18 (8018)</option>
          <option value="19">XKOP19 (8019)</option>
          <option value="20">XKOP20 (8020)</option>
        </select>
      </div>
      <div>
        <div class="label">SNMP Port</div>
        <input id="snmp_port" type="number" class="input" value="161" min="1" max="65535">
      </div>
    </div>
    <div class="header-right">
      <button class="btn" id="btn-import-hvi">üì• Import HVI</button>
      <button class="btn primary" id="btn-save">üíæ Save Config</button>
      <label class="btn" for="file-load">üìÇ Load Config</label>
      <input id="file-load" type="file" accept="application/json" style="display:none">
      <button class="btn" id="btn-export">üì§ Export</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tabs">
    <div class="tab active" data-panel="setup">Setup</div>
    <div class="tab" data-panel="test">Test Mode</div>
    <div class="tab" data-panel="live">Live Mirror</div>
    <div class="tab" data-panel="import">Import/Export</div>
    <div class="tab" data-panel="log-snmp">SNMP Log</div>
    <div class="tab" data-panel="log-xkop">XKOP Log</div>
    <div class="tab" data-panel="log-app">App Log</div>
    <div class="tab" data-panel="hvi">HVI Viewer</div>
    <div class="tab" data-panel="diag">Diagnostics</div>
  </div>

  <div class="panels">
    <!-- SETUP -->
    <div class="panel active" id="panel-setup">
      <div class="alert info">
        <strong>Configuration:</strong> Inputs are sent to controller via XKOP. Outputs come from controller (XKOP) and are published to instation via SNMP.
      </div>
      
      <div class="row-actions" style="margin-bottom:12px">
        <button class="btn success" id="btn-add-row">‚ûï Add Row</button>
        <button class="btn" id="btn-delete-selected">üóëÔ∏è Delete Selected</button>
        <button class="btn danger" id="btn-clear-rows">Clear All</button>
        <span class="small">Index (Idx) is only used for bitmask functions (those ending with "n")</span>
      </div>

      <div style="overflow-x:auto">
        <table class="table" id="setup-table">
          <thead>
            <tr>
              <th style="width:40px"><input type="checkbox" id="select-all"></th>
              <th style="width:70px">ID</th>
              <th>Input</th><th>SCN (in)</th><th>Func (in)</th><th>Idx (in)</th>
              <th>Output</th><th>SCN (out)</th><th>Func (out)</th><th>Idx (out)</th>
            </tr>
          </thead>
          <tbody id="setup-rows"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Available Functions</h3>
        <div class="grid">
          <div>
            <strong style="color:var(--accent)">Control Functions (Input ‚Üí Controller)</strong>
            <div class="small" style="margin-top:8px" id="control-funcs-list"></div>
          </div>
          <div>
            <strong style="color:var(--accent)">Reply Functions (Controller ‚Üí Instation)</strong>
            <div class="small" style="margin-top:8px" id="reply-funcs-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TEST MODE -->
    <div class="panel" id="panel-test">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0">Test Mode</h3>
            <div class="small">When enabled, automatic routing pauses. Use per-row buttons to manually test. Auto-disables after 1 hour.</div>
          </div>
          <div class="row-actions">
            <span id="test-status" class="pill warn">OFF</span>
            <span id="test-eta" class="badge" style="display:none">00:00:00</span>
            <button class="btn success" id="btn-test-on">Enable</button>
            <button class="btn danger" id="btn-test-off">Disable</button>
          </div>
        </div>
      </div>

      <div style="overflow-x:auto; margin-top:16px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:60px">NR</th>
              <th>Input</th><th>SCN/Func/Idx</th><th>Value</th><th>Action</th>
              <th>Output</th><th>SCN/Func/Idx</th><th>Value</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="test-rows"></tbody>
        </table>
      </div>
    </div>

    <!-- LIVE MIRROR -->
    <div class="panel" id="panel-live">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="small">Real-time state snapshot (read-only)</div>
        <div class="row-actions">
          <button class="btn success" id="btn-refresh-live">üîÑ Refresh</button>
          <button class="btn" id="btn-toggle-auto">‚è±Ô∏è Auto: <span id="auto-status">OFF</span></button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="table">
          <thead>
            <tr>
              <th style="width:60px">NR</th>
              <th>Input</th><th>SCN</th><th>Func</th><th>Idx</th><th>In Val</th>
              <th>Output</th><th>SCN</th><th>Func</th><th>Idx</th><th>Out Val</th>
            </tr>
          </thead>
          <tbody id="live-rows"></tbody>
        </table>
      </div>
    </div>

    <!-- IMPORT/EXPORT -->
    <div class="panel" id="panel-import">
      <div class="grid">
        <div class="card">
          <h3>Import Configuration</h3>
          
          <div style="margin-top:16px">
            <strong>From JSON File</strong>
            <div class="small" style="margin:8px 0">Load complete configuration from exported JSON</div>
            <input type="file" id="import-json-file" accept=".json" class="input" style="width:100%">
            <button class="btn success" onclick="importFromJSON()" style="margin-top:8px">üì• Import JSON</button>
          </div>

          <div style="margin-top:20px">
            <strong>From HVI File</strong>
            <div class="small" style="margin:8px 0">Import HVI file from disk</div>
            <input type="file" id="import-hvi-file" accept=".hvi,.txt" class="input" style="width:100%">
            <button class="btn success" onclick="importFromHVIFile()" style="margin-top:8px">üì• Import HVI File</button>
          </div>

          <div style="margin-top:20px">
            <strong>Fetch from Controller</strong>
            <div class="small" style="margin:8px 0">Download HVI directly from controller web interface</div>
            <button class="btn success" id="btn-fetch-hvi" style="width:100%">üåê Fetch HVI from Controller</button>
          </div>
        </div>

        <div class="card">
          <h3>Export Configuration</h3>
          <div class="alert info">
            Export your complete configuration for backup or migration to another system.
          </div>
          <div class="row-actions">
            <button class="btn success" onclick="exportConfig()">üì§ Export JSON</button>
            <button class="btn" onclick="exportCSV()">üìä Export CSV</button>
          </div>

          <h3 style="margin-top:24px">Import Results</h3>
          <div class="code" id="import-results" style="height:200px">
            <div class="small" style="color:#888">Import results will appear here...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGS -->
    <div class="panel" id="panel-log-snmp">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="small">SNMP activity (agent requests & responses)</div>
        <button class="btn success" onclick="refreshLogs()">üîÑ Refresh</button>
      </div>
      <pre class="code" id="snmp-log"></pre>
    </div>

    <div class="panel" id="panel-log-xkop">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="small">XKOP activity (UDP packets to/from controller)</div>
        <button class="btn success" onclick="refreshLogs()">üîÑ Refresh</button>
      </div>
      <pre class="code" id="xkop-log"></pre>
    </div>

    <div class="panel" id="panel-log-app">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="small">Application status & configuration changes</div>
        <button class="btn success" onclick="refreshLogs()">üîÑ Refresh</button>
      </div>
      <pre class="code" id="app-log"></pre>
    </div>

    <!-- HVI VIEWER -->
    <div class="panel" id="panel-hvi">
      <div class="alert info">
        <strong>HVI Maintenance Table:</strong> View and apply Input/Output names from the controller's HVI file.
      </div>
      <div class="row-actions" style="margin-bottom:12px">
        <button class="btn success" id="btn-apply-hvi">‚úÖ Apply Names from HVI</button>
        <button class="btn" id="btn-refresh-hvi">üîÑ Refresh HVI</button>
        <span class="small">Seeds Input/Output names from :BEGINMAINTABLE section</span>
      </div>
      <pre class="code" id="hvi-raw" style="height:500px"></pre>
    </div>

    <!-- DIAGNOSTICS -->
    <div class="panel" id="panel-diag">
      <div class="card">
        <h3>Network Diagnostics</h3>
        <button class="btn success" onclick="runDiagnostics()">üîç Run Diagnostics</button>
        <div id="diag-results" style="margin-top:16px">
          <div class="small" style="color:#888">Click button to run network diagnostics...</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>System Information</h3>
        <div id="system-info">
          <div class="small" style="color:#888">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---- Constants ---- */
const CONTROL_FUNCS=["-","DX","Dn","Fn","SFn","PV","PX","SO","SG","LO","LL","TS","FM","TO","HI","CP","EP","GO","FF","MO"];
const REPLY_FUNCS=["-","Gn","GX","DF","FC","SCn","HC","WI","PC","PR","CG","GR1","SDn","MC","CF","LE","RR","LFn","RF1","RF2","EV","VC","VO","GPn","VQ","CA","CR","CL","CSn","TF","VSn","CO","EC","CS","FR","BDn","TPn","SB","LC","MR","MF","ML"];

const $=s=>document.querySelector(s); 
const $$=s=>Array.from(document.querySelectorAll(s));

/* ---- State ---- */
let CONFIG={ip:"",instation_ip:"127.0.0.1",xkop:1,snmp_port:161,rows:[]};
let STATE={rows:[],test_mode:false,expires:null,last_update:0};
let HVI_TEXT="";
let AUTO_REFRESH_INTERVAL=null;

/* ---- Helpers ---- */
function funcHasIdx(f){ return (f||"").endsWith("n"); }

function makeInput(v,p=""){
  const i=document.createElement('input');
  i.className="input";
  i.value=v||"";
  i.placeholder=p;
  return i;
}

function makeSelect(list,val,cls){
  const s=document.createElement('select');
  s.className='select '+(cls||'');
  list.forEach(f=>{
    const o=document.createElement('option');
    o.value=f;
    o.textContent=f;
    s.appendChild(o);
  });
  s.value=(val&&list.includes(val))?val:"-";
  return s;
}

function syncIdx(tr){
  const iF=tr.querySelector('.in-func').value;
  const oF=tr.querySelector('.out-func').value;
  const ii=tr.querySelector('.in-idx');
  const oi=tr.querySelector('.out-idx');
  ii.disabled=!funcHasIdx(iF);
  oi.disabled=!funcHasIdx(oF);
  if(ii.disabled)ii.value="";
  if(oi.disabled)oi.value="";
}

function showNotification(type, message){
  const notif=document.createElement('div');
  notif.className=`notification alert ${type}`;
  notif.textContent=message;
  document.body.appendChild(notif);
  setTimeout(()=>notif.remove(), 4000);
}

function addImportLog(type, message){
  const container=$("#import-results");
  const entry=document.createElement('div');
  entry.className=`log-entry ${type}`;
  entry.textContent=`[${new Date().toLocaleTimeString()}] ${message}`;
  container.appendChild(entry);
  container.scrollTop=container.scrollHeight;
}

/* ---- Setup Table ---- */
function renderSetup(){
  const body=$("#setup-rows"); 
  body.innerHTML="";
  
  CONFIG.rows.forEach((r,ix)=>{
    const tr=document.createElement('tr');
    
    // Checkbox
    const cbTd=document.createElement('td');
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='row-checkbox';
    cbTd.appendChild(cb);
    tr.appendChild(cbTd);
    
    // ID (auto-numbered, read-only)
    const nrTd=document.createElement('td');
    nrTd.textContent=String(ix+1);
    nrTd.style.fontWeight='600';
    nrTd.style.color='var(--accent)';
    tr.appendChild(nrTd);
    
    // Inputs
    const inpTd=document.createElement('td');
    inpTd.appendChild(makeInput(r.input||"","Input name"));
    tr.appendChild(inpTd);
    
    const inScnTd=document.createElement('td');
    inScnTd.appendChild(makeInput(r.in_scn||"","SCN"));
    tr.appendChild(inScnTd);
    
    const inFuncTd=document.createElement('td');
    const sIn=makeSelect(CONTROL_FUNCS,r.in_func||"-","in-func");
    inFuncTd.appendChild(sIn);
    tr.appendChild(inFuncTd);
    
    const inIdxTd=document.createElement('td');
    const iIn=makeInput(r.in_idx||""); 
    iIn.classList.add("in-idx");
    inIdxTd.appendChild(iIn);
    tr.appendChild(inIdxTd);
    
    // Outputs
    const outpTd=document.createElement('td');
    outpTd.appendChild(makeInput(r.output||"","Output name"));
    tr.appendChild(outpTd);
    
    const outScnTd=document.createElement('td');
    outScnTd.appendChild(makeInput(r.out_scn||"","SCN"));
    tr.appendChild(outScnTd);
    
    const outFuncTd=document.createElement('td');
    const sOut=makeSelect(REPLY_FUNCS,r.out_func||"-","out-func");
    outFuncTd.appendChild(sOut);
    tr.appendChild(outFuncTd);
    
    const outIdxTd=document.createElement('td');
    const iOut=makeInput(r.out_idx||""); 
    iOut.classList.add("out-idx");
    outIdxTd.appendChild(iOut);
    tr.appendChild(outIdxTd);
    
    sIn.onchange=()=>syncIdx(tr); 
    sOut.onchange=()=>syncIdx(tr); 
    syncIdx(tr);
    
    body.appendChild(tr);
  });
  
  // Render function lists
  $("#control-funcs-list").innerHTML = CONTROL_FUNCS.filter(f=>f!=="-").map(f=>`<span class="badge">${f}</span>`).join(' ');
  $("#reply-funcs-list").innerHTML = REPLY_FUNCS.filter(f=>f!=="-").map(f=>`<span class="badge">${f}</span>`).join(' ');
}

function readSetup(){
  const out=[];
  $$("#setup-rows tr").forEach((tr,ix)=>{
    const inputs=Array.from(tr.querySelectorAll('input:not([type="checkbox"]),select'));
    if(inputs.length<8) return;
    const [inp,inScn,inFunc,inIdx,outp,outScn,outFunc,outIdx] = inputs.map(e=>e.value.trim());
    // Auto-assign nr based on row index
    out.push({nr:String(ix+1),input:inp,in_scn:inScn,in_func:inFunc,in_idx:inIdx,output:outp,out_scn:outScn,out_func:outFunc,out_idx:outIdx});
  });
  return out;
}

/* ---- Test Table ---- */
function renderTest(){
  const body=$("#test-rows"); 
  body.innerHTML="";
  
  (STATE.rows||[]).forEach((r,ix)=>{
    const tr=document.createElement('tr');
    
    const inVal=makeInput((r.in_value??"").toString()); 
    inVal.style.width="80px";
    const outVal=makeInput((r.out_value??"").toString()); 
    outVal.style.width="80px";
    
    const btnIn=document.createElement('button'); 
    btnIn.className="btn success"; 
    btnIn.textContent="‚Üí XKOP";
    btnIn.onclick=async()=>{
      const key=r.nr||r.input||(ix+1).toString();
      const val=parseInt(inVal.value||"0",10)||0;
      const res=await fetch("/test/input",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({key,value:val})
      });
      if(res.ok){
        await refreshState(); 
        renderLive();
        showNotification('success', `‚úì Sent to controller: ${key}=${val}`);
      } else {
        showNotification('error', '‚úó Test input failed');
      }
    };
    
    const btnOut=document.createElement('button'); 
    btnOut.className="btn success"; 
    btnOut.textContent="‚Üí SNMP";
    btnOut.onclick=async()=>{
      const key=r.nr||r.input||(ix+1).toString();
      const val=parseInt(outVal.value||"0",10)||0;
      const res=await fetch("/test/output",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({key,value:val})
      });
      if(res.ok){
        await refreshState(); 
        renderLive();
        showNotification('success', `‚úì Published to SNMP: ${key}=${val}`);
      } else {
        showNotification('error', '‚úó Test output failed');
      }
    };
    
    tr.innerHTML=`<td>${r.nr||ix+1}</td><td>${r.input||""}</td><td>${(r.in_scn||"")+' / '+(r.in_func||"-")+' / '+(r.in_idx||"")}</td><td></td><td></td>
                  <td>${r.output||""}</td><td>${(r.out_scn||"")+' / '+(r.out_func||"-")+' / '+(r.out_idx||"")}</td><td></td><td></td>`;
    tr.children[3].appendChild(inVal); 
    tr.children[4].appendChild(btnIn);
    tr.children[7].appendChild(outVal); 
    tr.children[8].appendChild(btnOut);
    
    body.appendChild(tr);
  });
}

function setTestUi(enabled,expires){
  const pill=$("#test-status"), eta=$("#test-eta");
  if(enabled){ 
    pill.textContent="ON"; 
    pill.className="pill ok"; 
    if(expires){
      eta.style.display="inline-block"; 
      eta.dataset.until=expires;
    }
  } else { 
    pill.textContent="OFF"; 
    pill.className="pill warn"; 
    eta.style.display="none"; 
    delete eta.dataset.until; 
  }
}

function tickCountdown(){
  const eta=$("#test-eta"); 
  const u=eta.dataset.until; 
  if(!u) return;
  const end=new Date(u).getTime(), now=Date.now(); 
  let s=Math.max(0,Math.floor((end-now)/1000));
  const hh=String(Math.floor(s/3600)).padStart(2,'0'); 
  s%=3600; 
  const mm=String(Math.floor(s/60)).padStart(2,'0'); 
  s%=60;
  eta.textContent=`${hh}:${mm}:${String(s).padStart(2,'0')}`;
}

/* ---- Live Mirror ---- */
function renderLive(){
  const body=$("#live-rows"); 
  body.innerHTML="";
  
  (STATE.rows||[]).forEach((r,ix)=>{
    const tr=document.createElement('tr');
    function td(t){
      const d=document.createElement('td'); 
      d.textContent=t??""; 
      return d;
    }
    tr.append(
      td(r.nr||ix+1),td(r.input),td(r.in_scn),td(r.in_func),td(r.in_idx),td(r.in_value),
      td(r.output),td(r.out_scn),td(r.out_func),td(r.out_idx),td(r.out_value)
    );
    body.appendChild(tr);
  });
}

/* ---- Logs ---- */
async function refreshLogs(){
  try{
    const [a,b,c]=await Promise.all([
      fetch('/log/snmp'),
      fetch('/log/xkop'),
      fetch('/log/app')
    ]);
    const snmpLogs=await a.json();
    const xkopLogs=await b.json();
    const appLogs=await c.json();
    
    $("#snmp-log").innerHTML=snmpLogs.map(log=>{
      let cls='info';
      if(log.includes('ERR')||log.includes('‚úó')) cls='error';
      else if(log.includes('‚úì')||log.includes('OK')) cls='success';
      return `<div class="log-entry ${cls}">${log}</div>`;
    }).join('');
    
    $("#xkop-log").innerHTML=xkopLogs.map(log=>{
      let cls='info';
      if(log.includes('ERR')||log.includes('‚úó')) cls='error';
      else if(log.includes('‚úì')||log.includes('OK')) cls='success';
      return `<div class="log-entry ${cls}">${log}</div>`;
    }).join('');
    
    $("#app-log").innerHTML=appLogs.map(log=>{
      let cls='info';
      if(log.includes('ERR')||log.includes('‚úó')) cls='error';
      else if(log.includes('‚úì')||log.includes('OK')) cls='success';
      return `<div class="log-entry ${cls}">${log}</div>`;
    }).join('');
  }catch(e){
    console.error('Failed to refresh logs:', e);
  }
}

/* ---- HVI ---- */
async function importHvi(){
  const ip=$("#ip").value.trim(); 
  const n=parseInt($("#xkop").value,10)||1;
  if(!ip){
    showNotification('warning', 'Enter controller IP first');
    return;
  }
  
  showNotification('info', `Fetching HVI from ${ip}...`);
  
  try{
    const res=await fetch(`/hvi?ip=${encodeURIComponent(ip)}&n=${n}`);
    const txt=await res.text(); 
    HVI_TEXT=txt; 
    $("#hvi-raw").textContent=txt; 
    activate('hvi');
    showNotification('success', `‚úì HVI fetched from ${ip}`);
  }catch(e){
    showNotification('error', `‚úó Failed to fetch HVI: ${e.message}`);
  }
}

function applyHviNames(){
  const m=/:BEGINMAINTABLE([\s\S]*?):ENDMAINTABLE/mi.exec(HVI_TEXT||""); 
  if(!m){
    showNotification('warning', 'No maintenance table found in HVI');
    return;
  }
  
  const rows=(m[1]||"").split(/\r?\n/).map(s=>s.trim()).filter(s=>s.startsWith(":D;;"));
  const map={};
  
  rows.forEach(line=>{
    const p=line.split(";"); 
    if(p.length>=7) {
      map[p[2]]={input:p[3],output:p[5]};
    }
  });
  
  let applied=0;
  CONFIG.rows.forEach(r=>{
    const t=map[r.nr]; 
    if(t){
      if(t.input) r.input=t.input; 
      if(t.output) r.output=t.output;
      applied++;
    }
  });
  
  renderSetup(); 
  showNotification('success', `‚úì Applied names from HVI to ${applied} rows. Save to persist.`);
}

async function importFromHVIFile(){
  const fileInput=$("#import-hvi-file");
  if(!fileInput.files[0]){
    showNotification('warning', 'Please select an HVI file');
    return;
  }
  
  try{
    const text=await fileInput.files[0].text();
    HVI_TEXT=text;
    $("#hvi-raw").textContent=text;
    addImportLog('success', `Loaded HVI file: ${fileInput.files[0].name}`);
    activate('hvi');
    showNotification('success', '‚úì HVI file loaded. Use "Apply Names" to update rows.');
  }catch(e){
    showNotification('error', `‚úó Failed to load HVI file: ${e.message}`);
    addImportLog('error', e.message);
  }
}

/* ---- Import/Export ---- */
async function importFromJSON(){
  const fileInput=$("#import-json-file");
  if(!fileInput.files[0]){
    showNotification('warning', 'Please select a JSON file');
    return;
  }

  try{
    const text=await fileInput.files[0].text();
    const imported=JSON.parse(text);
    CONFIG=imported;
    // Update UI fields with imported config
    $("#ip").value=CONFIG.ip||"";
    $("#instation_ip").value=CONFIG.instation_ip||"127.0.0.1";
    $("#xkop").value=String(CONFIG.xkop||1);
    $("#snmp_port").value=String(CONFIG.snmp_port||161);
    // Render the table with imported rows first, then save
    renderSetup();
    await saveConfig(true);
    addImportLog('success', `Imported configuration with ${CONFIG.rows?.length||0} rows`);
    showNotification('success', '‚úì Configuration imported successfully');
  }catch(e){
    showNotification('error', `‚úó Import failed: ${e.message}`);
    addImportLog('error', e.message);
  }
}

function exportConfig(){
  const blob=new Blob([JSON.stringify(CONFIG,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`ug405-config-${new Date().toISOString().slice(0,10)}.json`; 
  a.click(); 
  setTimeout(()=>URL.revokeObjectURL(url),500);
  showNotification('success', '‚úì Configuration exported');
}

function exportCSV(){
  let csv='Nr,Input,In SCN,In Func,In Idx,Output,Out SCN,Out Func,Out Idx\n';
  CONFIG.rows.forEach(r=>{
    csv+=`${r.nr||""},${r.input||""},${r.in_scn||""},${r.in_func||""},${r.in_idx||""},${r.output||""},${r.out_scn||""},${r.out_func||""},${r.out_idx||""}\n`;
  });
  
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`ug405-rows-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
  showNotification('success', '‚úì Rows exported as CSV');
}

/* ---- Diagnostics ---- */
async function runDiagnostics(){
  $("#diag-results").innerHTML='<div class="small" style="color:#888">Running diagnostics...</div>';
  
  try{
    const res=await fetch('/diag/network');
    const diag=await res.json();
    
    let html='<table class="table"><tbody>';
    for(const [key,value] of Object.entries(diag)){
      let displayValue=value;
      let badgeClass='';
      
      if(typeof value==='boolean'){
        displayValue=value?'‚úì OK':'‚úó FAIL';
        badgeClass=value?'pill ok':'pill error';
      }
      
      html+=`
        <tr>
          <td style="font-weight:600">${key.replace(/_/g,' ')}</td>
          <td>${badgeClass?`<span class="${badgeClass}">${displayValue}</span>`:displayValue}</td>
        </tr>
      `;
    }
    html+='</tbody></table>';
    
    $("#diag-results").innerHTML=html;
  }catch(e){
    $("#diag-results").innerHTML=`<div class="alert error">Failed to run diagnostics: ${e.message}</div>`;
  }
}

async function loadSystemInfo(){
  try{
    const res=await fetch('/diag');
    const info=await res.json();
    
    let html='<table class="table"><tbody>';
    for(const [key,value] of Object.entries(info)){
      const displayValue=typeof value==='object'?JSON.stringify(value,null,2):value;
      html+=`
        <tr>
          <td style="font-weight:600">${key}</td>
          <td><pre style="margin:0;font-size:.85rem">${displayValue}</pre></td>
        </tr>
      `;
    }
    html+='</tbody></table>';
    
    $("#system-info").innerHTML=html;
  }catch(e){
    $("#system-info").innerHTML=`<div class="alert error">Failed to load: ${e.message}</div>`;
  }
}

/* ---- Backend I/O ---- */
async function refreshConfig(){
  try{
    const res=await fetch('/config'); 
    CONFIG=await res.json();
    $("#ip").value=CONFIG.ip||""; 
    $("#instation_ip").value=CONFIG.instation_ip||"127.0.0.1";
    $("#xkop").value=String(CONFIG.xkop||1); 
    $("#snmp_port").value=String(CONFIG.snmp_port||161);
    
    (CONFIG.rows||[]).forEach(r=>{ 
      if(!CONTROL_FUNCS.includes(r.in_func)) r.in_func="-"; 
      if(!REPLY_FUNCS.includes(r.out_func)) r.out_func="-"; 
    });
    
    renderSetup();
  }catch(e){
    showNotification('error', `‚úó Failed to load config: ${e.message}`);
  }
}

async function refreshState(){
  try{
    const res=await fetch('/state'); 
    STATE=await res.json();
    setTestUi(STATE.test_mode, STATE.expires); 
    renderTest(); 
    renderLive();
  }catch(e){
    console.error('Failed to refresh state:', e);
  }
}

async function saveConfig(silent=false){
  CONFIG.ip=$("#ip").value.trim(); 
  CONFIG.instation_ip=$("#instation_ip").value.trim()||"127.0.0.1";
  CONFIG.xkop=parseInt($("#xkop").value,10)||1; 
  CONFIG.snmp_port=parseInt($("#snmp_port").value,10)||161;
  CONFIG.rows=readSetup();
  
  try{
    const r=await fetch('/config',{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(CONFIG)
    });
    
    if(!r.ok){
      showNotification('error', `‚úó Save failed: ${await r.text()}`);
      return;
    }
    
    await refreshConfig(); 
    await refreshState();
    if(!silent) showNotification('success', '‚úì Configuration saved successfully');
  }catch(e){
    showNotification('error', `‚úó Save failed: ${e.message}`);
  }
}

/* ---- Tabs ---- */
function activate(id){ 
  $$(".tab").forEach(t=>t.classList.toggle('active', t.dataset.panel===id)); 
  $$(".panel").forEach(p=>p.classList.toggle('active', p.id===`panel-${id}`));
  
  // Load data when switching to certain tabs
  if(id==='diag') loadSystemInfo();
  if(id==='hvi'&&!HVI_TEXT) importHvi();
}

/* ---- Auto-refresh ---- */
function toggleAutoRefresh(){
  const btn=$("#btn-toggle-auto");
  const status=$("#auto-status");
  
  if(AUTO_REFRESH_INTERVAL){
    clearInterval(AUTO_REFRESH_INTERVAL);
    AUTO_REFRESH_INTERVAL=null;
    status.textContent="OFF";
    showNotification('info', 'Auto-refresh disabled');
  }else{
    AUTO_REFRESH_INTERVAL=setInterval(async()=>{
      await refreshState();
    }, 2000);
    status.textContent="ON";
    showNotification('success', 'Auto-refresh enabled (2s interval)');
  }
}

/* ---- Events ---- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Tab switching
  $$("#tabs .tab").forEach(t=> t.addEventListener('click', ()=> activate(t.dataset.panel)));
  
  // Setup actions
  $("#btn-add-row").onclick=()=>{
    CONFIG.rows.push({
      nr:String(CONFIG.rows.length+1),
      input:"",in_scn:"",in_func:"-",in_idx:"",
      output:"",out_scn:"",out_func:"-",out_idx:""
    }); 
    renderSetup();
  };
  
  $("#btn-delete-selected").onclick=()=>{
    const checked=$$(".row-checkbox:checked");
    if(checked.length===0){
      showNotification('warning', 'No rows selected');
      return;
    }
    if(confirm(`Delete ${checked.length} selected row(s)?`)){
      const indices=checked.map(cb=>Array.from(cb.closest('tbody').children).indexOf(cb.closest('tr')));
      CONFIG.rows=CONFIG.rows.filter((_,i)=>!indices.includes(i));
      renderSetup();
      showNotification('success', `‚úì Deleted ${checked.length} row(s)`);
    }
  };
  
  $("#btn-clear-rows").onclick=()=>{ 
    if(confirm("Clear all rows?")){ 
      CONFIG.rows=[]; 
      renderSetup();
      showNotification('success', '‚úì All rows cleared');
    } 
  };
  
  $("#select-all").onclick=function(){
    $$(".row-checkbox").forEach(cb=>cb.checked=this.checked);
  };
  
  // Config actions
  $("#btn-save").onclick=()=>saveConfig();
  $("#btn-export").onclick=exportConfig;

  // Auto-save on field changes
  $("#ip").addEventListener('blur', ()=>saveConfig(true));
  $("#instation_ip").addEventListener('blur', ()=>saveConfig(true));
  $("#xkop").addEventListener('change', ()=>saveConfig(true));
  $("#snmp_port").addEventListener('change', ()=>saveConfig(true));

  $("#file-load").addEventListener('change',e=>{
    const f=e.target.files[0];
    if(f){
      const rd=new FileReader();
      rd.onload=async()=>{
        try{
          CONFIG=JSON.parse(rd.result);
          // Update UI fields with loaded config
          $("#ip").value=CONFIG.ip||"";
          $("#instation_ip").value=CONFIG.instation_ip||"127.0.0.1";
          $("#xkop").value=String(CONFIG.xkop||1);
          $("#snmp_port").value=String(CONFIG.snmp_port||161);
          // Render the table with loaded rows first, then save
          renderSetup();
          await saveConfig(true);
          showNotification('success', '‚úì Configuration loaded');
        }catch{
          showNotification('error', '‚úó Invalid config file');
        }
      };
      rd.readAsText(f);
    }
    e.target.value="";
  });
  
  // HVI actions
  $("#btn-import-hvi").onclick=importHvi;
  $("#btn-fetch-hvi").onclick=importHvi;
  $("#btn-apply-hvi").onclick=applyHviNames;
  $("#btn-refresh-hvi").onclick=importHvi;
  
  // Test mode actions
  $("#btn-test-on").onclick=async()=>{
    await fetch('/test/mode',{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({enabled:true})
    }); 
    await refreshState();
    showNotification('warning', '‚ö†Ô∏è Test Mode ENABLED');
  };
  
  $("#btn-test-off").onclick=async()=>{
    await fetch('/test/mode',{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({enabled:false})
    }); 
    await refreshState();
    showNotification('success', '‚úì Test Mode DISABLED');
  };
  
  // Live mirror actions
  $("#btn-refresh-live").onclick=refreshState;
  $("#btn-toggle-auto").onclick=toggleAutoRefresh;
  
  // Initial load
  await refreshConfig(); 
  await refreshState(); 
  await refreshLogs();
  
  // Auto-refresh logs
  setInterval(refreshLogs,3000);
  
  // Countdown ticker
  setInterval(tickCountdown,1000);
});
</script>
</body>
</html>
